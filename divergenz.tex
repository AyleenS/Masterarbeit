\chapter{Verfeinerungen für Kommunikationsfehler-, Ruhe- und Divergenz-Freiheit}

In diesem Kapitel soll die Menge der betrachteten Zustände noch einmal
erweitert werden. Somit werden dann Fehler-, Ruhe- und Divergenz-Zustände
betrachtet.

\begin{Def}[Divergenz]
  Ein \emph{Divergenz-Zustand} ist ein Zustand in einem \MEIO{} $P$, der eine
  unendliche Folge an $\tau$s ausführen kann via may-Transitionen.\\
  Die Menge $Div(P)$ besteht aus all diesen divergenten Zuständen des \MEIO{}s
  $P$.
\end{Def}

\begin{Prop}[Divergenz und Implementierung]
  \label{DivProp}
  Für ein \MEIO{} $P$ gilt $Div (P) = \left\{p'\in P'\mid P'\in\asimp (P)
  \land P' \text{ kann von } p' \text{ aus eine unendliche Folge von } \tau
  \text{s ausführen} \right\}$.
\end{Prop}
\begin{proof}
  Falls von einem $p'$ in einem $P'\in\asimp (P)$ eine unendliche $\tau$-Folge
  ausführbar ist, dann ist dies via must"=Transitionen möglich. Diese
  Transitionen müssen jedoch aus möglichen may"=Transitionen in $P$ folgen.
  Deshalb war auch der Zustand, der zu $p'$ in Simulations-Relation nach
  Definition~\ref{SimDef} steht, auch bereits divergent und in $Div (P)$
  enthalten. Für jedes $p$ aus $Div (P)$ gibt es eine unendliche Folge von
  $\tau$s, die via may"=Transitionen möglich ist in $P$. Also gibt es auch in
  $\asimp (P)$ mindestens eine Implementierung, die alle diese beteiligen
  may"=Transitionen als must"=Transitionen implementiert und einen zu $p$
  analogen Zustand als divergent enthält und somit in die Menge $\left\{p'\in
  P'\mid P'\in\asimp (P) \land P' \text{ kann von } p' \text{ aus eine
  unendliche Folge von } \tau \text{s ausführen} \right\}$ einfügt.
\end{proof}

Die unendliche Folge an $\tau$s kann durch eine Schleife an einem durch $\tau$s
erreichbaren Zustand ausführbar sein oder durch einen Weg, der mit $\tau$s
ausführbar ist, mit dem unendliche viele Zustände durchlaufen werden. Es ist
jedoch zu beachten, dass ein Zustand, von dem aus unendlich viele Zustände
durch $\tau$s  erreichbar sind, nicht divergent sein muss. Es ist auch möglich,
dass dieser Zustand eine unendliche Verzweigung hat und somit keine unendlichen
Folgen an $\tau$s ausführen kann.\\
Als Erreichbarkeitsbegriff wird wieder die lokale Erreichbarkeit verwendet. Da
das Divergieren eines Systems nicht mehr verhindert werden kann, sobald ein
divergenter Zustand lokal erreicht werden kann, ist Divergenz als ähnlich \glqq
schlimm\grqq{} zu bewerten wie ein Fehler-Zustand des Types
Kommunikationsfehler.

\begin{Def}[fehler-, ruhe- und divergenz-freie Kommunikation]
  Zwei \MEIO{}s $P_1$ und $P_2$ kommunizieren \emph{fehler-, ruhe- und
  divergenz-frei}, wenn keine as"=Implementierung ihrer Parallelkomposition
  $P_{12}$ einen Fehler-, Ruhe- oder Divergenz-Zustand lokal erreichen kann.
\end{Def}

\begin{Def}[Divergenz-Verfeinerungs-Basisrelation]
  Für \MEIO{}s $P_1$ und $P_2$ mit der gleichen Signatur wird $P_1\DBRel{} P_2$
  geschrieben, wenn ein Fehler-, Ruhe- oder Divergenz-Zustand in einer
  as"=Implementierung von $P_1$ nur dann lokal erreichbar ist, wenn es auch
  eine as"=Implementierung von $P_2$ gibt, in der ein solcher lokal erreichbar
  ist. Die \emph{Basisrelation} stellt eine \emph{Verfeinerung} bezüglich
  \emph{Fehler}, \emph{Ruhe} und \emph{Divergenz} dar.\\
  \DCRel{} bezeichnet die \emph{vollständig abstrakte Präkongruenz} von
  \DBRel{} bezüglich $\cdot\|\cdot$.
\end{Def}

Da nun die grundlegenden Definitionen für Divergenz festgehalten sind, kann man
sich einen Begriff für die Traces zu divergenten Zuständen bilden. Da oben
bereits festgestellt wurde, dass Divergenz als ähnlich „schlimmer Fehler“
anzusehen ist wie Kommunikationsfehler und dass das Divergieren eines Systems
nicht mehr verhinderbar ist, sobald ein divergenter Zustand lokal erreichbar
ist, kommt für die Divergenz-Traces wieder die \prune{}-Funktion zum Einsatz. Ein
System, das unendliche viele $\tau$s ausführen kann, ist von außen nicht von so
einem System zu unterscheiden, das einen Fehler-Zustand der Art
Kommunikationsfehler erreicht. Somit wird in den Trace-Mengen auch nicht
zwischen Kommunikationsfehler"=Traces und Divergenz-Traces explizit
unterschieden. Dadurch genügt es nicht mehr nur mit den
Kommunikationsfehler"=Traces die Sprache zu fluten, sondern es muss sowohl mit den
Kommunikationsfehler"=Traces wie auch den Divergenz"=Traces geflutet werden.
Ebenso werden die strikten Ruhe"=Traces mit diesen beiden Trace-Mengen
geflutet.

\begin{Def}[Divergenz-Traces]
  Sei $P$ ein \MEIO{} und definiere:
  \begin{itemize}
    \item \emph{strikte Divergenz-Traces}: $\StDT (P) := \left\{w\in\Sigma
      ^*\mid p_0\weakmay[w]_P p\in Div(P)\right\}$,
    \item \emph{gekürzte Divergenz-Traces}: $\PrDT (P) := \bigcup\left\{\prune
      (w)\mid w\in\StDT (P)\right\}$.
  \end{itemize}
\end{Def}

Analog zu den Propositionen~\ref{KommTracesProp} und~\ref{QuiTraceProp} gibt es
hier auch eine Proposition, die die Divergenz-Traces eines \MEIO{}s mit den
Divergenz-Traces seiner as"=Implementierungen verbindet. Die Begründung würde
analog wie die der beiden Propositionen der vorangegangenen Kapitel laufen, in
Kombination mit den Argumenten des Beweises zur Proposition~\ref{DivProp} in
diesem Kapitel.

\begin{Prop}[Divergenz-Traces und Implementierung]
  Für ein \MEIO{} $P$ gilt $\StDT (P) = \left\{w\in\Sigma ^*\mid \exists P' \in
  \asimp (P): p'_0\weakmust[w]_{P'} p'\in Div(P')\right\}$.
\end{Prop}

Da die Ruhe"=Traces mit den Kommunikationsfehler- und Divergenz"=Traces
geflutet werden sollen, kann die Ruhe"=Semantik nicht aus dem letzten Kapitel
übernommen werden auch die geflutete Sprache aus dem
Kommunikationsfehler-Kapitel kann nicht übernommen werden. Nur die
Kommunikationsfehler"=Traces \ET{} können ohne Veränderung auch in diesem
Kapitel verwendet werden. Jedoch werden diese Traces im weiteren Verlauf nur
innerhalb der größeren Trace-Menge \EDT{} relevant sein.

\begin{Def}[Kommunikationsfehler-, Ruhe- und Divergenz-Semantik]
  \label{DivSemDef}
  Sei $P$ ein \MEIO{}.
  \begin{itemize}
    \item Die Menge der \emph{Divergenz-Traces} von $P$ ist $\DT (P) := \cont
      (\PrDT (P))$.
    \item Die Menge der \emph{Fehler-Divergenz-Traces} von $P$ ist $\EDT (P) :=
      \ET (P)\cup\DT (P)$.
    \item Die Menge der \emph{Kommunikationsfehler-divergenz-gefluteten
      Ruhe-Traces} von $P$ ist $\QDT (P) := \StQT (P)\cup\EDT (P)$.
    \item Die Menge der \emph{Kommunikationsfehler-divergenz-gefluteten
      Sprache} von $P$ ist $\EDL (P) := L(P)\cup\EDT (P)$.
  \end{itemize}
  Für zwei \MEIO{}s $P_1,P_2$ mit der gleichen Signatur schreibt man $P_1\DRel
  P_2$, wenn $\EDT _1\subseteq \EDT _2, \QDT _1\subseteq \QDT _2$ und $\EDL
  _1\subseteq \EDL _2$ gilt.
\end{Def}

\DRel{} ist somit keine Einschränkung von \ERel{} so wie \QRel{}. Es können
Systeme mit einem Kommunikationsfehler nicht von Systemen mit Divergenz
unterschieden werden. Da die Basisrelation zwischen diesen Fehler-Arten auch
keine Unterscheidung kennt, muss eine sinnvolle Relation dies Eigenschaft auch
übernehmen, so wie \DRel{} dies tut.

\begin{Satz}[Kommunikationsfehler-, Ruhe- und Divergenz-Semantik für
  Parallelkompositionen]
  \label{DivSemSatz}
  Für zwei komponierbare \MEIO{}s $P_1,P_2$ und ihre Komposition $P_{12}$ gilt:
  \begin{enumerate}
    \item $\EDT _{12} =\cont (\prune ((\EDT _1\|\EDL _2)\cup (\EDL _1\|\EDT
      _2)))$,
    \item $\QDT _{12} =(\QDT _1\|\QDT _2)\cup \EDT _{12}$,
    \item $\EDL _{12} =(\EDL _1\|\EDL _2)\cup \EDT _{12}$.
  \end{enumerate}
\end{Satz}
\begin{proof}\mbox{}\\
  1. \glqq$\subseteq$\grqq{}:\\
  Da beide Seiten der Gleichung unter \cont{} abgeschlossen sind, genügt es ein
  präfix-minimales Element $w$ zu betrachten. Es muss hier unterschieden
  werden, ob $w\in\ET _{12}$ oder $w\in\DT _{12}\backslash\ET _{12}$ betrachtet
  wird. Im ersten Fall ist das $w$ in der rechten Seite der Gleichung enthalten
  wegen des Beweises des ersten Punktes von Satz~\ref{KommFehlerSemSatz} und da
  $\ET (P)\subseteq \EDT (P)$ und $\EL (P)\subseteq \EDL (P)$ gilt. Deshalb
  wird im weiteren Verlauf dieses Beweises davon ausgegangen, dass $w\in\DT
  _{12}\backslash\ET _{12}$ gilt und es wird versuch zu zeigen, dass dieses $w$
  ebenfalls in der rechten Seite enthalten ist. Da das betrachtete $w$
  präfix-minimal ist, gilt $w\in\PrDT _{12}\backslash\ET _{12}$. Aus der
  Definition~\ref{DivSemDef} weiß man, dass ein $v\in O^*_{12}$ existiert,
  sodass $(p_{01},p_{02})\weakmay[w]_{12} (p_1,p_2)\weakmay[v]_{12}
  (p'_1,p'_2)$ gilt mit $(p'_1,p'_2)\in Div _{12}$. Durch die Projektion auf die
  Transitionssysteme $P_1$ und $P_2$ erhält man $p_{01}\weakmay[w_1]_1 p_1
  \weakmay[v_1]_1 p'_1$ und $p_{02}\weakmay[w_2]_2 p_2\weakmay[v_2]_2 p'_2$ mit
  $w\in w_1\|w_2$ und $v\in v_1\|v_2$. Aus $(p'_1,p'_2)\in Div _{12}$ folgt,
  dass \oBdA{} $p'_1\in Div _1$ gilt, d.h.\ $w_1v_2\in\StDT _1\subseteq\EDT
  _1$. Da $p_{02}\weakmay[w_2v_2]_2$ gilt, erhält man $w_2v_2\in\EDL _2$. Somit
  gilt insgesamt $wv\in\EDT _1\|\EDL _2$ und da $v\in O^*_{12}$, ist $w$ in der
  rechten Seite der Gleichung enthalten und es folgt insgesamt $\prune (wv) =
  \prune (w)$.

  1. \glqq$\supseteq$\grqq{}:\\
  Es wird ebenso wie oben nur ein präfix-minimales $x$ betrachtet wegen des
  Abschlusses beider Seiten der Gleichung unter \cont{}. Es wird also für ein
  beliebiges $x\in\prune ((\EDT _1\|$ $\EDL _2)\cup (\EDL _1\|\EDT _2))$ gezeigt,
  dass dieses oder eines seiner Präfixe auch in $\EDT _{12}$ enthalten ist. Da
  das $x$ aus der \prune{}-Funktion entstanden ist, lässt sich ein $y$ aus
  $O^*_{12}$ finden, sodass $xy\in (\EDT _1\|\EDL _2)\cup (\EDL _1\|\EDT _2)$.
  Es wird nun noch vorausgesetzt, dass \oBdA{} $xy\in \EDT _1\|\EDL _2$ gilt,
  d.h.\ es existiert $w_1\in\EDT _1$ und $w_2\in\EDL _2$ mit $xy\in
  w_1\|w_2$.\\
  \TODO{erzwungenen Zeilenumbruch kontrollieren}\\
  Die folgende Argumentation läuft analog zu der im Beweis der Inklusion $\ET
  _{12} \supseteq \cont($ $\prune ((\ET _1\|\EL _2)\cup (\EL _1\|\ET _2)))$ aus
  Satz~\ref{KommFehlerSemSatz}. Es muss dazu nur jeweils an den Stellen, an
  denen $\PrET (P)\cup\MIT (P)$ steht auch noch eine Vereinigung mit $\PrDT
  (P)$ vorgenommen werden. Für Fall I und II aus dem Beweis der oben genannten
  Inklusion von Satz~\ref{KommFehlerSemSatz} ist jeweils kein weiterer
  Unterfall für $v'_2$ notwendig da, wenn $v'_2$ nicht ausführbar ist, bereits
  ein Fehler-Zustand der Art Kommunikationsfehler in der Parallelkomposition
  entsteht. Somit ist egal, ob auch noch Divergenz vorlag. Falls $v'_2$
  ausführbar, ist nicht relevant, ob eine Divergenz-Möglichkeit bestanden hat,
  da diese nicht an der Ausführbarkeit ändert. Am Ende ist ein zusätzlicher
  Fall für $v_1\in\PrDT _1$ zu ergänzen:
  \TODO{erzwungenen Zeilenumbruch kontrollieren}
  \begin{itemize}
    \item Fall III ($v_1\in\PrDT _1$): Es existiert ein $u_1$ aus $O^*_1$,
      sodass $p_{01}\weakmay[v_1]_1 p_1\weakmay[u_1]_1 p'_1$ mit $p'_1\in Div
      _1$ gilt. Da es hier keine disjunkten Inputmengen gibt kann das $a$, auf das $v_1$
      im Fall $v_1\neq\varepsilon$ endet, ebenfalls der letzte Buchstabe von $v_2$
      sein. Im Fall von $v_2\in\MIT _2$ kann somit $a=b$ gelten und damit wäre
      $v_2=v'_2$. Dieser Fall verläuft jedoch analog zu Fall Ic) aus dem Beweis
     der oben genannten Inklusion von Satz~\ref{KommFehlerSemSatz} und wird
      somit hier nicht weiter betrachtet. Deshalb gilt für alle im folgenden
      betrachteten Fälle $p_{02}\weakmay[v'_2]_2 p_2$ mit $(p_{01},p_{02})
      \weakmay[v']_2$.
      \begin{itemize}
        \item Fall IIIa) \big($u_2\in (O_1\cap I_2)^*,c\in (O_1\cap I_2)$,
          sodass $u_2c$ ein Präfix von $u_1|_{I_2}$ mit $p_2\weakmust[u_2]_2
          p'_2 \nmust[c]_2$\big): Für ein Präfix von $u'_1c$ von $u_1$ mit
          $(u'_1c)|_{I_2}=u_2c$ weiß man, dass $p_1\weakmay[u'_1]_1 p''_1
          \may[c]_1$. Somit gilt $u'_1\in u'_1\|u_2$ und $(p_1,p_2)
          \weakmay[u'_1]_{12} (p''_1,p'_2)\in E_{12}$, da für $P_2$ der
          entsprechende Input fehlt, der mit dem Output von $c$ von $P_1$ zu
          koppeln wäre. Es handelt sich also um einen neuen
          Kommunikationsfehler. Es wird $v:=\prune (v'u'_1) \in\PrET _{12}$
          gewählt, dies ist ein Präfix von $v'$, da $u_1\in O^*_1$.
        \item Fall IIIb) \big($p_2\weakmust[u_2]_2 p'_2$ mit $u_2=u_1|_{I_2}$
          \big): Somit ist $u_1\in u_1\|u_2$ und $(p_1,p_2)\weakmay[u_1]_{12}
          (p'_1,p'_2)\in Div _{12}$, da $p_1\in Div _1$. $P_{12}$ hat also die
          Divergenz von $P_1$ geerbt. Es wird nun $v:=\prune (v'u_1)\in\PrDT
          _{12}$ gewählt, das wiederum ein Präfix von $v'$ ist.
      \end{itemize}
  \end{itemize}

  2. \glqq$\subseteq$\grqq{}:\\
  Diese Inklusionsrichtung kann analog zum Beweis derselben Inklusionsrichtung
  des zweiten Punktes von Satz~\ref{RuheSemSatz} gezeigt werden. Es muss dabei
  nur in der Argumentation die Menge $\ET _{12}$ durch die Menge $\EDT _{12}$
  und die Mengen $\QET (P)$ durch die Mengen $\QDT (P)$ für die entsprechenden
  Transitionssysteme $P$ ersetzt werden. Dadurch kann ebenso gefolgert werden,
  dass im Fall $w\in\StQT _{12}\backslash\EDT _{12}$ der erreichte Zustand
  $(p_1,p_2)$ kein Kommunikationsfehler sein kann, da $\ET _{12}\subseteq\EDT
  _{12}$ gilt und somit lässt sich auch hier der zweite Punkt von
  Lemma~\ref{RuheZustLem} anwenden.

  2. \glqq$\supseteq$\grqq{}:\\
  Es muss wieder danach unterschieden werden, aus welcher Menge das betrachtete
  Element stammt. Falls $w$ ein Element von $\EDT _{12}$ ist, folgt die
  Zugehörigkeit zur linken Seite der Gleichung direkt. Somit wird für den
  weiteren Verlauf dieses Beweises davon ausgegangen, dass $w\in\QDT _1\|\QDT
  _2$ gilt. Für dieses $w$ soll dann gezeigt werden, dass es auch in $\QDT
  _{12}$ enthalten ist. Da $\QDT _i=\StQT _i\cup\EDT _i$ gilt, existierten für
  $w_1$ und $w_2$ mit $w\in w_1\|w_2$ unterschiedliche Möglichkeiten:
  \begin{itemize}
    \item Fall 1 ($w_1\in\EDT _1\lor w_2\in\EDT _2$): \OBdA{} gilt $w_1\in\EDT
      _1$. Es kann nun $w_2\in\StQT _2\subseteq L_2$ gelten oder $w_2\in\EDT
      _2\subseteq \EDL _2$ und somit gilt auf jeden Fall $w_2\in\EDL _2$.
      Daraus kann mit dem ersten Punkt dieses Satzes gefolgert werden, dass
      $w\in\EDT _{12}$ gilt und somit $w$ in der linken Seite der Gleichung
      enthalten ist.
    \item Fall 2 ($w_1\in\StQT _1\backslash\EDT _1\land w_2\in\StQT
      _2\backslash\EDT _2$): Dieser Fall läuft analog zu Fall 2 derselben
      Inklusionsrichtung des Beweises von Satz~\ref{RuheSemSatz}. Hierfür muss
      die Menge $\QET _{12}$ durch $\QDT _{12}$ ersetzt werden.
  \end{itemize}

  3.:\\
  Durch die Definition~\ref{DivSemDef} ist klar, dass $L_i\subseteq\EDL _i$ und
  $\EDT _i\subseteq\EDL _i$ gilt. Die Argumentation wird von der rechten Seite
  der Gleichung aus begonnen:
  \begin{align*}
    (\EDL _1\| \EDL _2)\cup \EDT _{12}
    &\overset{\ref{DivSemDef}}{=}\left(\left(L _1\cup \EDT _1\right)\|\left(L
    _2\cup \EDT _2\right)\right)\cup \EDT _{12}\\
    &=(L _1\|L _2) \cup \underset{\overset{1.}{\subseteq} \EDT
    _{12}}{\underset{\subseteq (\EDL _1\|\EDT _2)}{\underbrace{(L _1\|\EDT
    _2)}}} \cup \underset{\overset{1.}{\subseteq} \EDT
    _{12}}{\underset{\subseteq (\EDT _1\|\EDL _2)}{\underbrace{(\EDT _1\|L
    _2)}}}\\
    &\quad\quad\cup \underset{\overset{1.}{\subseteq} \EDT
    _{12}}{\underset{\subseteq (\EDL _1\|\EDT _2)}{\underbrace{(\EDT _1\|\EDT
    _2)}}} \cup \EDT _{12}\\
    &=(L _1\|L _2) \cup \EDT _{12}\\
    &\overset{\ref{LParallelProp}}{=}L _{12}\cup \EDT _{12}\\
    &\overset{\ref{DivSemDef}}{=}\EDL _{12}.
  \end{align*}
\end{proof}

Analog wie in den beiden vorangegengenen Kapitel, ergibt sich aus diesem Satz
als direkte Folgerung, dess es sich bei der Relation \DRel{} um eine
Präkongruenz handelt.

\begin{Kor}[Divergenz-Präkongruenz]
  Die Relation \DRel{} ist eine Präkongruenz bezüglich $\cdot\|\cdot$.
\end{Kor}
\begin{proof}
  Um zu zeigen, dass es sich bei \DRel{} um eine Präkongruenz handelt, muss
  nachgewiesen werden, dass aus $P_1\DRel P_2$ auch $P_{31}\DRel P_{32}$ für
  jedes komponierbare System $P_3$ folgt. D.h.\ es ist zu zeigen, dass aus
  $\EDT _1\subseteq\EDT _2, \QDT _1\subseteq\QDT _2$ und $\EDL _1\subseteq\EDL
  _2$, sowohl $\EDT _{31} \subseteq \EDT _{32}, \QDT _{31} \subseteq \QDT
  _{32}$ als auch $\EDL _{31}\subseteq\EDL _{32}$ folgt. Dies ergibt sich, wie
  in den Beweisen zu den Korollaren~\ref{KommPraekonKor}
  und~\ref{RuhePraekonKor}, aus der Monotonie von \cont{}, \prune{} und
  $\cdot\|\cdot$ auf Sprachen wie folgt:
  \begin{itemize}
    \item $\begin{aligned}[t]
        \EDT{}_{31} &\overset{\ref{DivSemSatz}~1.}{=}
        \cont{}\left(\prune{}\left(\left(\EDT{}_3\|\EDL{}_1\right) \cup
        \left(\EDL{}_3\|\EDT{}_1\right)\right)\right)\\
        &\hspace{-0.6cm}\overset{\EDT{}_1\subseteq
      \EDT{}_2}{\overset{\mathrm{und}}{\overset{\EDL{}_1\subseteq
    \EDL{}_2}{\subseteq}}}
    \cont{}\left(\prune{}\left(\left(\EDT{}_3\|\EDL{}_2\right) \cup
        \left(\EDL{}_3\|\EDT{}_2\right)\right)\right)\\
      &\overset{\ref{DivSemSatz}~1.}{=} \EDT{}_{32},
    \end{aligned}$
    \item $\begin{aligned}[t]
        \QDT{}_{31} &\overset{\ref{DivSemSatz}~2.}{=} (\QDT{}_3\|\QDT{}_1)
        \cup \EDT{}_{31}\\
        &\hspace{-0.8cm}\overset{\EDT{}_{31}\subseteq
      \EDT{}_{32},}{\overset{\mathrm{und}}{\overset{\QDT{}_1\subseteq
      \QDT{}_2}{\subseteq}}} (\QDT{}_3\|\QDT{}_2) \cup \EDT{}_{32}\\
      &\overset{\ref{DivSemSatz}~2.}{=} \QDT{}_{32}.
    \end{aligned}$
    \item $\begin{aligned}[t]
        \EDL{}_{31} &\overset{\ref{DivSemSatz}~3.}{=} (\EDL{}_3\|\EDL{}_1)
        \cup \EDT{}_{31}\\
        &\hspace{-0.8cm}\overset{\EDT{}_{31}\subseteq
      \EDT{}_{32},}{\overset{\mathrm{und}}{\overset{\EDL{}_1\subseteq
      \EDL{}_2}{\subseteq}}} (\EDL{}_3\|\EDL{}_2) \cup \EDT{}_{32}\\
      &\overset{\ref{DivSemSatz}~3.}{=} \EDL{}_{32}.
    \end{aligned}$
  \end{itemize}
\end{proof}

Als nächstes soll nun eine Verfeinerungsrelation bezüglich guter Kommunikation
von Transitionssytemen im Sinne von fehler-, ruhe- und divergenz-freier
Kommunikation betrachtet werden. Es muss in diesem Lemma eine Veränderung zu
den analogen Lemata aus den vorangegengenen Kapitel vorgenommen werden. Die
Einschränkung, dass $U$ ein Partner sein muss, kann nicht mehr beibehalten
werden, da die Strategie zur Vermeidung von Ruhe im Beweis aus dem letzten
Kapitel hier zu Divergenz führen würde. Somit werden für die Ruhe-Vermeidung in
diesem Kapitel Aktionen außerhalb der Menge \Synch{} benötigt, die nicht die
interne Aktionen $\tau$ sind. Jedoch müssen trotzdem nicht alle komponierbaren
\MEIO{}s $U$ betrachtet werden. Es kann eine Einschränkung gemacht werden,
sodass $U$ fast ein Partner ist. Zur Vereinfachung von umständlichen
Formulierungen im Folgenden wird hierfür nun ein neuer Begriff definiert. Der
jedoch auch bereits so in~\cite{Schinko2016BA} für \EIO{}s verwendet und
definiert wurde.

\begin{Def}[{\boldmath$\omega$}-Partner]
  Ein \MEIO{} $P_1$ ist ein $\omega$-Partner von einem \MEIO{} $P_2$, wenn
  $I_1=O_2$ und $O_1=I_2\cup\{\omega\}$ mit $\omega\notin I_2\cup O_2$ gilt.
\end{Def}

Ein $\omega$-Partner $P_1$ von $P_2$ unterscheidet sich von einem Partner von
$P_2$ nur um den Output $\omega$, der nicht in der Menge $\Synch (P_1,P_2)$
enthalten ist.

\begin{Lem}[Verfeinerung mit Divergenz-Zuständen]
  \label{DivVerfeinLem}
  Gegeben sind zwei \MEIO{}s $P_1$ und $P_2$ mit der gleichen Signatur. Wenn
  $U\|P_1\DBRel U\|P_2$ für alle $\omega$-Partner $U$ gilt, dann folgt daraus
  $P_1\DRel P_2$.
\end{Lem}
\begin{proof}
  Da $P_1$ und $P_2$ die gleiche Signatur haben, definiert man $I:=I_1=I_2$ und
  $O:=O_1=O_2$. Für jeden $\omega$-Partner $U$ gilt $I_U=O$ und
  $O_U=I\cup\{\tau\}$ mit $\omega\notin I\cup O$.\\
  Um zu zeigen, dass die Relation $P_1\DRel P_2$ gilt, müssen die folgenden
  Punkte nachgewiesen werden:
  \begin{itemize}
    \item $\EDT _1\subseteq \EDT _2$,
    \item $\QDT _1\subseteq \QDT _2$,
    \item $\EDL _1\subseteq \EDL _2$.
  \end{itemize}
  In den Lemmata~\ref{KommVerfeinLem} und~\ref{RuheVerfeinLem} wurde bereits
  etwas Ähnliches gezeigt. Jedoch kann daraus aufgrund der unterschiedlichen
  Basisrelationen, die zur Anwendung kommen, nichts über dieses Lemma und
  dessen Gültigkeit ausgesagt werden. Es kann in diesem Lemma, ebenso wie in
  Lemma~\ref{RuheVerfeinLem}, aus der lokalen Erreichbarkeit eines
  Kommunikationsfehlers in $P'_1$ und dem Zusammenhang von $P'_1\DBRel P'_2$
  nur geschlossen werden, dass es in $P_2$ auch einen lokal erreichbaren
  Fehler geben muss, jedoch kann dieser Fehler hier ein Kommunikationsfehler,
  Ruhe oder Divergenz sein. \DBRel{} sagt dies nicht direkt aus, jedoch wenn
  $P'_1$ einen Kommunikationsfehler lokal erreicht, dann gibt es auch eine
  Implementierung aus $\asimp (P'_1)$, die ebenfalls einen Fehler-Zustand
  erreicht und daraus lässt sich mit \DBRel{} folgern, dass es auch eine
  as"=Implementierung von $P'_2$ gibt, auch einen Fehler, aber einer beliebigen
  Art erreichen kann. Da eine as"=Implementierung von $P'_2$ dies kann, folgt
  mit Definition~\ref{SimDef}, dass dies auch $P'_2$ kann. Für einen
  Kommunikationsfehler gilt dieser Folgerunge aufgrund von~\ref{SimDef} 3. und
  bei einem ruhigen Zustand, da sonst~\ref{SimDef} 1.\ wiedersprochen werden
  würde. Definition~\ref{SimDef} 2.\ setzt für einen Divergenz-Zustand die
  nötigen may"=$\tau$"=Transitionen in $P'_2$ vorraus. Analog verhält es sich,
  wenn in $P_1$ ein Divergenz-Zustand oder Ruhe-Zustand lokal erreichbar ist.

  Als Erstes wird der erste Beweispunkt gezeigt, also die Inklusion $\EDT
  _1\subseteq\EDT _2$.\\
  Es wird für ein präfix-minimales $w$ aus $\EDT _1$ gezeigt, dass dieses $w$
  oder eines seiner Präfixe in $\EDT _2$ enthalten ist. Diese Möglichkeit
  bietet sich, da beide Mengen unter \cont{} abgeschlossen sind.
  \begin{itemize}
    \item Fall 1 ($w=\varepsilon$): Es handelt sich um einen lokal erreichbaren
      Kommunikationsfehler oder um lokale erreichbare Divergenz in $P_1$. Für
      $U$ wrid ein Transitionssysteme verwendet, das nur aus dem Startzustand
      und einer must"=Schleife für alle Inputs $x\in I_U$ und einer
      must"=Schleife für $\omega$ besteht. Somit kann $P_1$ im Prinzip die
      gleichen Fehler- und Divergenz-Zustände wie $U\|P_1$ lokal erreichen.
      Daraus folgt, dass es eine as"=Implementierung von $U\|P_1$ gibt, die
      diese Fehler ebenfalls lokal erreicht und somit aufgrund von $U\|P_1
      \DBRel U\|P_2$ auch eine as"=Implementierung von $U\|P_2$ exisitert, die
      auch lokal einen Fehler erreicht. Dieser muss mit der Begründung von oben
      auch in $U\|P_2$ lokal erreichbar sein. Durch die Strucktur von $U$ ist
      in einer Parallelkomposition mit $U$ kein Ruhe-Zustand möglich. Der
      Fehler, der in $U\|P_2$ lokal erreichbar ist, muss also ein Fehler- oder
      Divergenz-Zustand sein. Da von $U$ kein Kommunikationfehler und keine
      Divergenz geerbt werden kann und durch die Inputschleife auch kein neuer
      Kommunikationsfehler entstehen kann, muss der Fehler von $P_2$ geerbt
      sein. Somit gilt also, dass in $P_2$ ein Fehler- oder Divergenz-Zustand
      lokal erreichbar ist. Da $\EDT (P) =\ET (P)\cup\DT (P)$ gilt, folgt $w\in
      \EDT _2$.
    \item Fall 2 ($w=x_1\dots x_n x_{n+1}\in\Sigma ^+$ mit $n\geq 0$ und
      $x_{n+1}\in I$): Es wird der folgende $\omega$-Partner $U$ betrachtet
      (siehe auch Abbildung~\ref{UohneEmitO}):
      \begin{itemize}
        \item $U=\{p_0,p_1,\dots ,p_{n+1}\}$,
        \item $p_{0U}=p_0$,
        \item $\begin{aligned}[t]
            \must _U=&\{(p_i,x_{i+1},p_{i+1})\mid  0\leq i\leq n\}\\
            &\cup\{(p_i,x,p_{n+1})\mid  x\in I_U\backslash\{x_{i+1}\}, 0\leq
            i\leq n\}\\
            &\cup\{(p_{n+1},x,p_{n+1})\mid  x\in I_U\}\\
            &\cup\{(p_i,\omega ,p_{n+1})\mid 0\leq i\leq n+1\},
        \end{aligned}$
        \item $E_U=\emptyset$.
      \end{itemize}
      \begin{figure} [h!tbp]
      \begin{center}
        \begin{tikzpicture}[->, >=latex',auto,node distance =3cm, semithick]
          \node (0) {$p_0$};
          \node (1) [right of=0] {$p_1$};
          \node (dots) [right of=1] {$\dots$};
          \node (n) [right of=dots] {$p_n$};
          \node (n1) at ($(1)!0.5!(dots) + (0,-3)$) {$p_{n+1}$};

          \path ($ (0) + (-1,0) $) edge (0)
                (0) edge node {$x_1$} (1)
                    edge [bend right] node [below, sloped] {$x?\neq x_1, \omega
                    !$} (n1)
                (1) edge node {$x_2$} (dots)
                    edge node [below, sloped] {$x?\neq x_2, \omega !$} (n1)
                (dots) edge node {$x_n$} (n)
                       edge [dashed] (n1)
                (n) edge node [above, sloped] {$x?\in I_U, \omega !$} (n1)
                    edge [bend left] node [sloped] {$x_{n+1}$!} (n1)
                (n1) edge [loop below] node {$x?\in I_U, \omega !$} (n1);
        \end{tikzpicture}
        \caption{$x?\neq x_i$ steht für alle $x\in I_U\backslash\{x_i\}$}
      \label{UohneEmitO}
      \end{center}
      \end{figure}
      Die Mengen der Divergenz- und Ruhe-Zuständer des hier betrachteten $U$s
      sind leer. Da im Vergleich zum Transitionssytem in Abbildung~\ref{UohneE}
      nur die $\omega$-Transitionen zu $p_{n+1}$ ergänzt wurden, ändert sich
      nicht an dem Fall 2a) im ersten Punkt des Beweises von
      Lemma~\ref{KommVerfeinLem}. Im Fall 2b) muss die Menge $O^*$ durch
      $(O\cup\{\tau\})^*$ ersetzt werden. Die Begründungen, wieso in den beiden
      Fällen $\varepsilon\in\PrET (P')$ für ein $P'\in\asimp (U\|P_1)$ gilt,
      bleibt also analog zum Beweis von Lemma~\ref{KommVerfeinLem}. Da nun aber
      auch Divergenz betrachtet wird, muss ein weiterer Fall ergänzt werden:
      \begin{itemize}
        \item Fall 2c) ($w\in\PrDT _1$): In $U\|P_1$ erhält man $(p_0,p_{01})
          \weakmay[w] (p_{n+1},p'')\weakmay[u] (p_{n+1},p')$ für $u\in (O\cup
          \{\tau\})^*$ und $p'\in Div_1$. Daraus folgt $(p_{n+1},p')\in
          Div_{U\|P_1}$ und somit $wu\in\StDT (U\|P_1)$. Da alle Aktionen aus
          $w$ synchonisiert werden und $I_u\cap I_1=\emptyset$ gilt $x_1,\dots
          , x_n, x_{n+1}\in O_{U\|P_1}$. Da zusätzlich $u$ in $(O\cup \{\tau\})
          ^*$ enthalten ist, folgt $u\in O^*_{U\|P_1}$. Somit ergibt sich
          $\varepsilon\in\PrDT (U\|P_1)$ und auch für eine as"=Implementierung
          $P'$ von $U\|P_1$ ist $\varepsilon$ in $\PrDT (P')$ enthalten.
      \end{itemize}
      Da $\varepsilon$ in $\PrET (P') \cup \PrDT (P')$ enthalten ist für ein
      $P'\in\asimp (U\|P_1)$, kann mit der Relation $U\|P_1\DBRel U\|P_2$
      geschlossen werden, dass in einer as"=Implementierung von $U\|P_1$ ein
      Fehler lokal erreichbar sein muss. Mit der Argumentation am Anfang dieses
      Beweises ist somit auch ein Fehler in $U\|P_2$ lokal erreichbar. Durch
      die $\omega$-Tranisitionen an den Zuständen von $U$ kann es in
      Komposition mit $U$ keine Ruhe-Zustände geben. Der Fehler muss also ein
      Kommunikationsfehler oder Divergenz sein.
      \begin{itemize}
        \item Fall 2i) ($\varepsilon\in\ET (U\|P_2)$ wegen neuem
          Kommunikationsfehler): Da jeder Zustand von $U$ alle Inputs $x\in
          I_U=O$ zulässt, muss ein lokal erreichbarer Fehler-Zustand in diesem
          Fall der Form sein, dass ein Output $a\in O_U\backslash\{\omega\}$
          von $U$ möglich ist, der nicht mit einem passenden Input aus $P_2$
          synchronisiert werden kann. Durch die Konsturktion von $U$ ist in
          $p_{n+1}$ kein Output außer $\omega$ möglich. Ein neuer
          Kommunikationsfehler muss also die Form $(p_i,p')$ haben mit $i\leq
          n, p'\nmust[x_{i+1}]$ und $x_{i+1}\in O_U\backslash\{\omega\}$. Durch
          Projektion erhält man dann $p_{02}\lweakmay[x_1\dots x_i] p'
          \nmust[x_{i+1}]$ und damit gilt $x_1\dots x_{i+1}\in\MIT _2\subseteq
          \ET _2$. Somit ist ein Präfix von $w$ in $\EDT _2$ enthalten.
        \item Fall 2ii) ($\varepsilon\in\ET (U\|P_2)$ wegen geerbtem Fehler):
          $U$ hat $x_1\dots x_iu$ ausgeführt mit $u\in (O\cup\{\omega\})^*$ und
          ebenso hat $P_2$ den Weg $x_1\dots x_iu|_{\Sigma _2}$ ausgeführt.
          Durch dies hat $P_2$ einen Zustand aus $E_2$ erreich, da von $U$ kein
          Fehler geerbt werden kann. Es gilt dann $\prune (x_1\dots x_iu|
          _{\Sigma _2})=\prune (x_1\dots x_i)\in\PrET _2\subseteq\ET _2$. Da
          $x_1\dots x_i$ ein Präfix von $w$ ist, führt in diesem Fall eine
          Verlängerung um lokale Aktionen von einem Präfix von $w$ zu einem
          Fehler-Zustand. Da \ET{} der Menge aller Verlängerungen von gekürzten
          Kommunikationsfehler-Traces entspricht, ist $x_1\dots x_i$ in $\EDT
          _2$ enthalten und somit ist ein Präfix von $w$ in $\EDT _2$
          enthalten.
        \item Fall 2iii) ($\varepsilon\in\DT (U\|P_2)\backslash\ET (U\|P_2)$):
          Da $U$ nicht unendlich viele Zustände hat und auch keine
          $\tau$-Schleifen besitzt, kann das Divergenzverhalten nur von $P_2$
          geerbt sein. $U$ hat $x_1\dots x_iu$ ausgeführt mit $u\in
          (O\cup\{\omega\})^*$ und ebenso hat $P_2$ den Weg $x_1\dots
          x_iu|_{\Sigma _2}$ ausgefhört. Durch dies hat $P_2$ einen Zustand aus
          $Div_2$ erreicht. Es gilt dann $\prune (x_1\dots x_iu|_{\Sigma _2}) =
          \prune (x_1\dots x_i)\in\PrDT _2\subseteq\DT _2$, da $u|_{\Sigma _2}$
          in $O^*$ enthalten ist. Da $x_1\dots x_i$ ein Präfix von $w$ ist,
          führt in diesem Fall eine Verlängerung um lokale Aktionen von einem
          Präfix von $w$ zu einem divergenten Zustand. Da \DT{} die Menge aller
          Verlängerungen von gekürzten Divergenz-Traces ist und $\DT
          _2\subseteq \EDT _2$ gilt, ist in diesem Fall das Präfix $x_1\dots
          x_i$ von $w$ in $\EDT _2$ enthalten.
      \end{itemize}
  \end{itemize}

  Als nächstes wird nu der zweite Beweispunkt gezeigt, d.h.\ die Inklusion
  $\QDT _1\subseteq\QDT _2$. Diese Inklusion kann jedoch noch, analog zum
  Beweis der Inklusion der Kommunikationsfehler-gefluteten Sprache aus dem
  Kommunikationsfehler-Kapitel, weiter eingeschränkt werden. Da bereits bekannt
  ist, das $\EDT _1\subseteq\EDT _2$ gilt, muss nur noch $\StQT _1\backslash
  \EDT _1\subseteq\QDT _2$ gezeigt werden.\\
  Es wird ein $w\in\StQT _1\backslash\EDT _1$ gewählt und gezeigt, dass dieses
  auch in $\QDT _2$ enthalten ist.\\
  \TODO{zu beweisen}

  \TODO{Beweis für dritten Punkt}
\end{proof}

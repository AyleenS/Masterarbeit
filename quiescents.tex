\chapter{Verfeinerungen für Kommunikationsfehler- und Ruhe-Freiheit}

In diesem Kapitel wird die Menge der betrachteten Zustandsmengen von den
Kommunikations-basierten Fehlern im letzten Kapitel erweitert um
Ruhe-Zustände.\\
Zustände, die keine Outputs ohne einen Input ausführen können in Form einer
must"=Transition, werden als in einer Art Verklemmung angesehen, da sie ohne
Zutun von Außen den Zustand nicht mehr verlassen können, falls möglicherweise
vorhandener may"=Output nicht implementiert wird. So ein Zustand hat also keine
must"=Transitions"=Möglichkeiten für einen Output. Falls dieser Zustand die
Möglichkeit für eine interne Aktion via einer must"=Transition hat, darf durch
die $\tau$s niemals ein Zustand erreicht werden, von dem aus ein Output in
Implementierungen erzwungen wird. Ein Zustand, der keine Outputs und $\tau$s
via must"=Transitionen ausführen kann, ist also ein Deadlock-Zustand, in denen
das System nichts mehr tun können muss ohne einen Input. Wenn man eine
Erweiterung um $\tau$s zu Zuständen ohne must"=Outputs zulässt, hat man
zusätzlich noch Verklemmungen der Art Livelock, da diese Zustände
möglicherweise beliebig viele interne Aktionen ausführen können, jedoch nie aus
eigener Kraft einen wirklichen Fortschritt in Form eines Outputs bewirken
können müssen. Die Menge der Zustände, die sich in einer Verklemmung
befinden, würde also durch $\left\{p\in P\mid \forall a\in O: p\nweakmust[a]_P
\right\}$ beschrieben werden. Somit wären dies alle Zustände, die keine
Möglichkeit haben ohne einen Input von Außen oder eine implementierte
may"=Output"=Transition je weider einen Output machen zu können. Falls man
diese Definition verwenden würde, müsste man immer alle Zustände betrachten,
die durch $\tau$s erreichbar sind. Dies würde einige Betrachtungen deutlich
aufwendiger machen und soll deshalb hier nicht behandelt werden. Die Definition
für die betrachteten Verklemmungen, hier Ruhe genannt, beschränkt sich auf
Zustände, die keine Outputs und $\tau$s ausführen können.

\begin{Def}[Ruhe]
  Ein \emph{Ruhe-Zustand} ist ein Zustand in einem \MEIO{} $P$, der keine
  Outputs und kein $\tau$ zulässt via must"=Transitionen.\\
  Somit ist die Menge der Ruhe-Zustände in einem \MEIO{} $P$ wie folgt formal
  definiert: $Qui(P):=\left\{p\in P\mid \forall\alpha\in (O\cup\{\tau\}):p
  \nmust[\alpha]_P\right\}$.
\end{Def}

\begin{Prop}[Ruhe und Implementierung]
  Für ein \MEIO{} $P$ gilt: $Qui(P) = \left\{p'\in P'\mid P'\in\asimp (P)\land
  \forall\alpha\in (O\cup\{\tau\}):p' \nmust[\alpha]_{P'}\right\}$.
\end{Prop}
\begin{proof}
  Da für alle $P'\in\asimp (P)$ $\must_{P'} =\may_{P'}$ gilt, dürfen alle $p'$
  keine ausgehenden Transitionen haben. Nach Definition~\ref{SimDef} dürfen zu
  $p'$ in Relation stehenden Zustände $p$ in $P$ keine ausgehenden
  must"=Transitionen haben, da $p'$ diese sonst implementieren müsste. Somit
  sind alle $p'$, die die Forderung dieser Proposition enthalten auch in $Qui
  (P)$ enthalten. Für alle $p$, die in $Qui (P)$ enthalten sind, gibt es keine
  ausgehenden must"=Transitionen für Outputs oder die interne Aktion $\tau$,
  somit können diese Aktionen entweder keine ausgehende Transition von $p$ sein
  oder nur als may"=Transition von $p$ zu einem möglicherweise anderen Zustand
  führen. Nicht vorhandenen Transitionen in $P$ sind auch in keiner
  as"=Implementierung von $P$ enthalten und es gibt mindestens eine
  Implementierung in $\asimp (P)$, die alle ausgehenden may"=Transitionen der
  lokalen Aktionen von $p$ nicht implementiert, somit sind alle $p$ aus $Qui
  (P)$ auch in $\left\{p'\in P'\mid P'\in\asimp (P)\land \forall\alpha\in
  (O\cup\{\tau\}):p' \nmust[\alpha]_{P'}\right\}$ enthalten.
\end{proof}

Für die Erreichbarkeit wird wie im letzten Kapitel ein optimistischer Anzahl
der lokalen Erreichbarkeit für die Fehler-Zustände, der Kommunikationsfehler,
verwendet. Ruhe ist kein unabwendbarer Fehler, sondern kann durch einen Input
repariert werden oder im Fall von vorhandenen may"=Output"=Transitionen, durch
eine Implementierung dieses Outputs. Daraus ergibt sich, dass Ruhe im Vergleich
zu Kommunikationsfehler als weniger \glqq schlimmer Fehler\grqq{} anzusehen
ist. Somit ist ein Ruhe-Zustand ebenso wie ein Fehler-Zustand erreichbar,
sobald er durch Outputs und $\tau$s erreicht werden kann, jedoch ist nicht jede
beliebige Fortsetzung eines Traces, das durch lokale Aktionen zu einem
Ruhe-Zustand führt ein Ruhe"=Trace.

\begin{Def}[fehler- und ruhe-freie Kommunikation]
  Zwei \MEIO{}s $P_1$ und $P_2$ \emph{kommunizieren fehler- und ruhe-frei},
  wenn keine as"=Implementierung ihrer Parallelkomposition $P_{12}$ einen
  Fehler- oder Ruhe-Zustand lokal erreichen kann.
\end{Def}

\begin{Def}[Ruhe-Verfeinerungs-Basisrelation]
  Für \MEIO{}s $P_1$ und $P_2$ mit der gleichen Signatur wird $P_1\QBRel P_2$
  geschrieben, wenn ein Fehler- oder Ruhe-Zustand in einer as"=Implementierung
  von $P_1$ nur dann lokal erreichbar ist, wenn es auch eine
  as"=Implementierung von $P_2$ gibt, in der ein solcher lokal erreichbar ist.
  Diese \emph{Basisrelation} stellt eine \emph{Verfeinerung} bezüglich
  \emph{Kommunikationsfehlern} und \emph{Ruhe} dar.\\
  \QCRel{} bezeichnet die \emph{vollständig abstrakte Präkongruenz} von
  \QBRel{} bezüglich $\cdot\|\cdot$.
\end{Def}

Um eine genauere Auseinandersetzung mit den Präkongruenzen zu ermöglichen,
benötigt man wie im letzten Kapitel die Definition von Traces auf der Struktur.
Dadurch erhält man die Möglichkeit die gröbste Präkongruenz charakterisieren zu
können. Wie bereits oben erwähnt, ist Ruhe ein reparierbarer Fehler im
Gegensatz zu Kommunikationsfehlern. Es genügt deshalb für Ruhe die strikten
Traces ohne Kürzung zu betrachten.

\begin{Def}[Ruhe-Traces]
  Sei $P$ ein \MEIO{} und definiere:
  \begin{itemize}
    \item \emph{strikte Ruhe-Traces}: $\StQT (P) := \left\{w\in\Sigma ^*\mid
      p_0 \weakmay[w]_P p\in Qui(P)\right\}$.
  \end{itemize}
\end{Def}

\begin{Prop}[Ruhe-Traces und Implementierung]
  \label{QuiTraceProp}
  Für ein \MEIO{} $P$ gilt $\StQT (P) = \left\{w\in\Sigma ^*\mid \exists
  P'\in\asimp (P): p'_0 \weakmust[w]_{P'} p'\in Qui(P')\right\}$.
\end{Prop}
\begin{proof}
  Da $P'$ einen mit $w$ beschrifteten must"=Trace enthält und $P'$ eine
  as"=Implementierung von $P$ ist, muss $w$ als may"=Trace bereits in $P$
  möglich gewesen sein (Definition~\ref{SimDef}). Der Zustand $p'$ kann in $P'$
  auch nur ruhig sein, wenn der entsprechende in Relation stehende Zustand aus
  $P$ auch bereits ruhig war. Alle $w$ aus $\big\{w\in\Sigma ^*\mid \exists
  P'\in\asimp (P):$ $p'_0 \weakmust[w]_{P'} p'\in Qui(P')\big\}$ sind somit also
  auch in $\StQT (P)$ enthalten. Jeder may"=Trace aus $P$ kann implementiert
  werden durch eine as"=Implementierung. Die Menge $\asimp (P)$ enthält alle
  as"=Implementierungen von $P$, also auch eine, die den $w$ may"=Trace aus
  $\StQT (P)$ zu einem mit in $p$ Relation stehenden Zustand implementiert. $p$
  enthält keine ausgehenden Transitionen für lokale Aktionen, also gibt es
  unter den as"=Implementierungen, die $w$ entsprechend als must"=Trace
  enthalten auch mindestens eine, die keine ausgehende lokale Aktion an dem zu
  $p$ in Relation stehenden Zustand implementiert. Die Behauptung gilt also.
\end{proof}

Für \ET{} und \EL{} gelten die Definitionen aus dem letzten Kapitel. Es wir nur
für Ruhe eine neue Semantik definiert.

\begin{Def}[Ruhe-Semantik]
  Sei $P$ ein \MEIO{}.
  \begin{itemize}
    \item Die Menge der \emph{fehler-gefluteten Ruhe-Traces} von $P$ ist $\QET
      (P):= \StQT (P)\cup\ET (P)$.
  \end{itemize}
  Für zwei \MEIO{}s $P_1,P_2$ mit der gleichen Signatur wird $P_1\QRel{} P_2$
  geschrieben, wenn $P_1\ERel{} P_2$ und $\QET _1\subseteq \QET _2$ gilt.
\end{Def}

\begin{Lem}[Ruhe-Zustände unter Parallelkomposition]\mbox{}
  \begin{enumerate}
    \item Ein Zustand $(p_1,p_2)$ aus der Parallelkomposition $P_{12}$ ist
      ruhig, wenn es auch die Zustände $p_1$ und $p_2$ in $P_1$ bzw. $P_2$
      sind.
    \item Wenn der Zustand $(p_1,p_2)$ ruhig ist und nicht in $E_{12}$
      enthalten ist, dann sind auch die auf die Teilsysteme projizierten
      Zustände $p_1$ und $p_2$ ruhig.\\
      \TODO{anpassen (nur einer muss ruhig sein, der andere kann
      must-Transitionen für synchronisierte Outputs haben)}
  \end{enumerate}
\end{Lem}
\begin{proof}\mbox{}
  \begin{enumerate}
    \item Da $p_1\in Qui_1$ und $p_2\in Qui_2$ gilt, haben diese beiden
      Zustände jeweils höchstens die Möglichkeit für Input Transitionen oder
      Output und $\tau$ may"=Transitionen, jedoch keine Möglichkeit für Outputs
      oder $\tau$s als must"=Transitionen.\\
      Angenommen der Zustand, der durch die Parallelkomposition aus den
      Zuständen $p_1$ und $p_2$ entsteht, ist nicht ruhig, d.h.\ er hat eine
      ausgehende must"=Transition für einen Output oder ein $\tau$.
      \begin{itemize}
        \item Fall 1 \big($(p_1,p_2)\must[\tau]$\big): Ein $\tau$ ist eine interne
          Aktion und kann in der Parallelkomposition nicht durch das Verbergen
          von Aktionen bei der Synchronisation entstehen. Ein $\tau$ in der
          Parallelkomposition ist also auch nur möglich, wenn dies bereits für
          einen der beiden Zustände als must"=Transition im der einzelnen
          Komponente möglich war für einen der Zustände, aus denen $(p_1,p_2)$
          zusammensetzt ist. Jedoch verbietet die Voraussetzung, dass $p_1$
          oder $p_2$ eine ausgehende $\tau$ must"=Transition haben, deshalb
          kann auch $(p_1,p_2)$ keine solche Transition besitzen.
        \item Fall 2 \big($(p_1,p_2)\must[a]$ mit $a\in O_{12}\backslash
          \Synch(P_1,P_2)$\big): Da es sich bei $a$ um einen Output handelt, der
          nicht in $\Synch (P_1,P_2)$ enthalten ist, kann dieser nicht aus der
          Synchronisation von zwei Aktionen entstanden sein, sondern muss
          bereits für $P_1$ oder $P_2$ als must"=Transition ausführbar gewesen
          sein. Es gilt also \oBdA{} $p_1\must[a]$ mit $a\in O_1$. Dies ist
          jedoch aufgrund der Voraussetzung nicht möglich. Somit kann die
          Parallelkomposition diese Transition für $(p_1,p_2)$ ebenfalls nicht
          als must"=Transition enthalten.
        \item Fall 3 \big($(p_1,p_2)\must[a]$ mit $a\in O\cap\Synch
          (P_1,P_2)$\big): Der Output $a$ ist in diesem Fall durch
          Synchronisation von einem Output mit einem Input entstanden. \OBdA{}
          gilt $a\in O_1\cap I_2$. Für die einzelnen Systeme muss also gelten,
          dass $p_1\must[a]$ und $p_2\must[a]$. Die Transition für das System
          $P_1$ ist jedoch in der Voraussetzung ausgeschlossen worden. Somit
          ist es nicht möglich, dass $P_{12}$ diese in diesem Fall angenommene
          must"=Transition für den Zustand $(p_1,p_2)$ ausführen kann.
      \end{itemize}
    \item \TODO{zu beweisen}
  \end{enumerate}
\end{proof}

\begin{Satz}[Kommunikationsfehler- und Ruhe-Semantik für Parallelkompositionen]
  Für zwei komponierbare \MEIO{}s $P_1,P_2$ und ihre Komposition $P_{12}$ gilt:
  \begin{enumerate}
    \item $\ET _{12}=\cont (\prune ((\ET _1\|\EL _2)\cup (\EL _1\|\ET _2)))$,
    \item $\QET _{12}=(\QET _1\|\QET _2)\cup\ET _{12}$,
    \item $\EL _{12}=(\EL _1\|\EL _2)\cup\ET _{12}$.
  \end{enumerate}
\end{Satz}
\begin{proof}
  Es wird nur der 2. Punkt beweisen.\\
  \TODO{zu beweisen}
\end{proof}

\chapter{Verfeinerungen für Kommunikationsfehler-Freiheit}

Dieses Kapitel versucht die Präkongruenz für Error bei \EIO{}s
aus~\cite{Schinko2016BA} auf die hier betrachten \MEIO{}s zu erweitern.

\begin{Def}[fehler-freie Kommunikation]
  Ein Fehler"=Zustand ist \emph{lokal erreichbar} in einer
  as"=Implementierung $P'$ eines \MEIO{} $P$, wenn ein $w\in O^*$ existiert mit
  $p'_0 \weakmust[w]p'\in E'$.\\
  Zwei \MEIO{}s $P_1$ und $P_2$ \emph{kommunizieren fehler-frei}, wenn keine
  as"=Implementierungen ihrer Parallelkomposition $P_{12}$ einen
  Fehler"=Zustände lokal erreichen kann.
\end{Def}

\begin{Def}[Kommunikationsfehler-Verfeinerungs-Basirelation]
  Für zwei \MEIO{}s $P_1$ und $P_2$ mit der gleichen Signatur wird $P_1\EBRel{} P_2$
  geschrieben, wenn ein Fehler"=Zustand in einer as"=Implementierung
  von $P_1$ nur dann lokal erreichbar ist, wenn es auch eine as"=Implementierung
  von $P_2$ gibt, in der dieser Fehler"=Zustand auch lokal
  erreichbar ist. Die Basisrelation stellt eine \emph{Verfeinerung} bezüglich
  \emph{Kommunikationsfehlern} dar.\\
  \ECRel{} bezeichnet die \emph{vollständig abstrakte Präkongruenz} von
  \EBRel{} bezüglich $\cdot\|\cdot$, d.h.\ die gröbste Präkongruenz bezüglich
  $\cdot\|\cdot$, die in \EBRel{} enthalten ist.
\end{Def}

Für as"=Implementierungen $P_1$ und $P_2$ entspricht \EBRel{} der Relation
\EBbaRel{} aus~\cite{Schinko2016BA}.

Wie in~\cite{Schinko2016BA} werden die Fehler hier Trace-basiert betrachtet. Da
jedoch die Basisrelation über as"=Implementierungen spricht, sind die Trace-Mengen
auch nicht für die \MEIO{}s mit may-Transitionen definiert sondern nur für die
Menge der möglichen as"=Implementierungen eines solchen \MEIO{}s.

\begin{Def}[Kommunikationsfehler-Traces]
  Für ein \MEIO{} $P$ wird definiert:
  \begin{itemize}
    \item \emph{strikte Kommunikationsfehler-Traces}: $\StET (P) :=
      \left\{w\in\Sigma ^* \mid p_0 \weakmay[w] p \in E\right\}$,
    \item \emph{gekürzte Kommunikationsfehler-Traces}: $\PrET (P) :=
      \left\{\prune (w) \mid w\in\StET (P)\right\}$,
    \item \emph{Input-kritische-Traces}: $\MIT (P) := \left\{wa\in\Sigma ^*
      \mid p_0 \weakmay[w] p \land a\in I\land p\nmust[a] \right\}$.
  \end{itemize}
\end{Def}

\begin{Prop}[Kommunikationsfehler-Traces und Implementierung]
  Für ein \MEIO{} $P$ gilt:
  \begin{enumerate}
    \item \emph{strikte Kommunikationsfehler-Traces}: $\StET (P) =
      \big\{w\in\Sigma ^* \mid \exists P' \in\asimp (P) :$ $p'_0 \weakmust[w]
      p' \in E\big\}$ \TODO{erzwungen Zeilenumbruch kontrollieren}
    \item \emph{Input-kritische-Traces}: $\MIT (P) = \left\{wa\in\Sigma ^* \mid
      \exists P' \in\asimp (P) : p'_0 \weakmust[w] p' \land \right.$\linebreak
      $\left. a\in I\land p'\nmust[a] \right\}$ \TODO{erzwungen Zeilenumbruch kontrollieren}
  \end{enumerate}
\end{Prop}
\begin{proof}\mbox{}
  \begin{enumerate}
    \item Wie schon in Beweis zu~\ref{LImpProp} festgestellt, sind alle
      Abläufe, die in $P$ via may"=Transitionen möglich ist in mindestens einer
      as"=Implementierung von $P$ via must"=Transitionen möglich. Umgekehrt ist
      auch jeder Ablauf, der in einer as"=Implementierung von $P$ möglich ist
      auch in $P$ durch may"=Transitionen möglich.\\
      Aufgrund des 3.\ Punktes der Definition~\ref{SimDef} kann jede
      as"=Implementierung von $P$ nur Fehler-Zustände enthalten,
      die auch $P$ enthält. Da alle möglichen Implementierungen von $P$ in
      $\left\{w\in\Sigma ^* \mid \exists P' \in\asimp (P) : p'_0 \weakmust[w]
      p' \in E\right\}$ betrachtet werden, ist auch jeder in $P$ durch
      may"=Transitionen erreichbare Fehler"=Zustand auch in
      mindestens einer as"=Implementierung ebenfalls erreichbar, jedoch durch
      must"=Transitionen.
    \item Für jedes $w$ in $L(P)$ gibt es mindestens eine as"=Implementierung
      von $P$, die dieses $w$ auch ausführen kann und umgekehrt (Beweis
      von~\ref{LImpProp}). Falls in $\MIT (P)$ mindestens ein Element gibt,
      gibt es in $P$ einen Trace von $w$, nach dem ein Input $a$ nicht
      zwingendermaßen folgen muss. Die $a$ Transition also entweder eine
      may"=Transition ist oder gar nicht existiert in $P$. Es muss also auch
      einen $w$ Trace in einer as"=Implementierung geben, die in einem Zustand
      endet, der mit dem Zustand aus $P$ in Relation steht, in dem das $a$
      nicht erzwungen wird. Falls die Transition in $P$ nicht vorhanden ist,
      muss jede as"=Implementierung, die so einen $w$ Trace enthält auch $wa$
      als Input-kritischen-Trace haben. Andernfalls handelt es sich bei $a$ in
      $P$ um eine may"=Transition, die von mindestens einer
      as"=Implementierung, die den $w$ Trace enthält, nicht implementiert wird
      und somit $wa$ auch als Input-kritischen-Trace enthält.\\
      Für ein $wa\in \left\{wa\in\Sigma ^* \mid \exists P' \in\asimp (P) : p'_0
      \weakmust[w] p' \land a\in I\land p'\nmust[a] \right\}$ muss es eine
      as"=Implementierung von $P$ geben, die diesen Input-kritischen-Trace
      implementiert. $P$ muss also auch das $w$ ausführen können zu einem
      Zustand, in dem $P$ $a$ nicht als must"=Transition enthalten. Falls $P$
      $a$ nach $w$ nur als must"=Transition enthalten würde, würde~\ref{SimDef}
      1.\ die Implementierung von $a$ erzwingen würde und somit könnte für
      keine as"=Implementierung von $P$ $wa$ ein Input-kritischer-Trace sein.
      Es gilt also auch $wa\in\MIT (P)$.
  \end{enumerate}
\end{proof}

\begin{Def}[Kommunikationsfehler-Semantik]
  \label{KommFehlerSemDef}
  Sei $P$ ein \MEIO{}.
  \begin{itemize}
    \item Die Menge der \emph{Kommunikationsfehler-Traces} von $P$ ist $\ET (P)
      := \cont (\PrET (P)) \cup\cont (\MIT (P))$.
    \item Die \emph{Kommunikationsfehler-geflutete Sprache} von $P$ ist $\EL
      (P) := L(P) \cup \ET (P)$.
  \end{itemize}
  Für zwei \MEIO{}s $P_1,P_2$ mit der gleichen Signatur wird $P_1\ERel P_2$
  geschrieben, wenn $\ET _1\subseteq \ET _2$ und $\EL _1 \subseteq \EL _2$
  gilt.
\end{Def}

Hierbei ist zu beachten, dass die Mengen \StET{}, \PrET{}, \MIT{}, \ET{} und
\EL{} nur denen aus~\cite{Schinko2016BA} entsprechen, wenn $P$ bereits eine
as"=Implementierung ist.

\begin{Satz}[Kommunikationsfehler-Semantik für Parallelkompositionen]
  \label{KommFehlerSemSatz}
  Für zwei komponierbare \MEIO{}s $P_1,P_2$ und ihre Komposition $P_{12}$ gilt:
  \begin{enumerate}
    \item $\ET _{12} = \cont (\prune ((\ET _1\|\EL _2) \cup (\EL _1\|\ET
      _2)))$,
    \item $\EL _{12} = (\EL _1\|\EL _2) \cup \ET _{12}$.
  \end{enumerate}
\end{Satz}
\begin{proof}\mbox{}\\
  1. \glqq$\subseteq$\grqq{}:\\
  Da beide Seiten der Gleichung unter der Fortsetzung \cont{} abgeschlossen
  sind, genügt es ein präfix-minimales Element $w$ von $\ET _{12}$ zu
  betrachten. Diese Element ist aufgrund der Definition der Menge der
  Errortraces in $\MIT _{12}$ oder in $\PrET _{12}$ enthalten.
  \begin{itemize}
    \item Fall 1 ($w\in\MIT _{12}$): Aus der Definition von \MIT{} folgt, dass
      es eine Aufteilung $w=xa$ gibt mit $(p_{01},p_{02}) \weakmay[x] (p_1,p_2)
      \land a \in I_{12} \land (p_1,p_2) \nmust[a]$. Da $I_{12} = (I_1\cup I_2)
      \backslash (O_1\cup O_2)$ ist, folgt $a\in (I_1\cup I_2)$ und $a\notin
      (O_1\cup O_2)$. Es wird unterschieden, ob $a\in (I_1\cap I_2)$ oder $a\in
      (I_1\cup I_2) \backslash (I_1\cap I_2)$ ist.
    \begin{itemize}
      \item Fall 1a) ($a\in (I_1\cap I_2)$): Durch Projektion des Ablaufes auf
        die einzelnen Transitionssysteme erhält man \oBdA{}
        $p_{01}\weakmay[x_1] p_1\nmust[a]$ und $p_{02}\weakmay[x_2]
        p_2\nmust[a]$ oder $p_{02}\weakmay[x_2] p_2\must[a]$ mit $x\in
        x_1\|x_2$. Daraus kann $x_1a\in \cont (\MIT _1) \subseteq \ET _1$ und
        $x_2a\in \EL _2$ ($x_2a\in \MIT _2$ oder $x_2a \in L_2$) gefolgert
        werden. Damit folgt $w\in (x_1\|x_2) \cdot \{a\} \subseteq
        (x_1a)\|(x_2a)\subseteq \ET _1\|\EL _2$, und somit ist $w$ in der
        rechten Seite der Gleichung enthalten.
      \item Fall 1b) ($a\in (I_1\cup I_2)\backslash (I_1\cap I_2)$): \OBdA{}
        gilt $a\in I_1$. Durch die Projektion auf die einzelnen Komponenten
        erhält man: $p_{01}\weakmay[x_1] p_1\nmust[a]$ und $p_{02}\weakmay[x_2]
        p_2$ mit $x\in x_1\|x_2$. Daraus folgt $x_1a\in \cont (\MIT _1)
        \subseteq \ET _1$ und $x_2\in L_2\subseteq \EL _2$. Somit gilt $w\in
        (x_1\|x_2) \cdot \{a\} \subseteq (x_1a)\|x_2\subseteq \ET _1\|\EL _2$.
        Dies ist eine Teilmenge der rechten Seite der Gleichung.
    \end{itemize}
  \item Fall 2 ($w\in\PrET _{12}$): Aus der Definition von \PrET{} und \prune{}
    folgt, dass ein $v\in O_{12}^*$ gilt, so dass $(p_{01},p_{02}) \weakmay[w]
      (p_1,p_2) \weakmay[v] (p'_1,p'_2)$ gilt mit $(p'_1,p'_2)\in E_{12}$ und
      $w=\prune (wv)$. Durch Projektion auf die Komponenten erhält man $p_{01}
      \weakmay[w_1] p_1 \weakmay[v_1] p'_1$ und $p_{02} \weakmay[w_2] p_2
      \weakmay[v_2] p'_2$ mit $w\in w_1\|w_2$ und $v\in v_1\|v_2$. Aus
      $(p'_1,p'_2)\in\ET _{12}$ folgt, dass es sich entweder um einen geerbten
      oder einen neuen Fehler handelt. Bei einem geerbten wäre bereits einer
      der beiden Zustände $p'_1$ bzw.\ $p'_2$ ein Fehler"=Zustand gewesen. Ein
      neuer Kommunikationsfehler hingegen wäre durch das fehlen der
      Synchronisations-Erzwingung (fehlende must"=Transition) in einer der
      Komponenten entstanden.
    \begin{itemize}
      \item Fall 2a) (geerbter Fehler): \OBdA{} gilt $p'_1\in E_1$. Daraus
        folgt, $w_1v_1\in StET_1 \subseteq \cont (\PrET _1) \subseteq \ET _1$.
        Da $p_{02} \weakmay[w_2v_2]$ gilt, erhält man $w_2v_2\in L_2\subseteq
        \EL _2$. Dadurch ergibt sich $wv\in \ET _1\|\EL _2$ mit $w=\prune (wv)$
        und somit ist $w$ in der rechten Seite der Gleichung enthalten.
      \item Fall 2b) (neuer Kommunikationsfehler): \OBdA{} gilt $a\in I_1\cap
        O_2$ mit $p'_1\nmust[a]\land p'_2\may[a]$. Daraus folgt $w_1v_1a\in
        \MIT _1 \subseteq \ET _1$ und $w_2v_2a\in L_2 \subseteq \EL _2$. Damit
        ergibt sich $wva\in \ET _1\|\EL_2$, da $a\in O_1\subseteq O_{12}$ gilt
        $w=\prune (wva)$ und somit ist $w$ in der rechten Seite der Gleichung
        enthalten.
    \end{itemize}
  \end{itemize}

  1. \glqq$\supseteq$\grqq{}:\\
  Wegen der Abgeschlossenheit beider Seiten der Gleichung gegenüber \cont{}
  wird auch in diesem Fall nur ein präfix-minimales Element $x\in\prune ((\ET
  _1\|\EL _2)\cup (\EL _1\| \ET _2))$ betrachtet. Da $x$ durch die Anwendung
  der \prune{}-Funktion entstanden ist, existiert ein $y\in O_{12} ^*$ mit
  $xy\in (\ET _1\|\EL _2)\cup (\EL _1\| \ET _2)$. \OBdA{} wird davon
  ausgegangen, dass $xy\in \ET _1\| \EL _2$ gilt, d.h.\ es gibt $w_1\in \ET _1$
  und $w_2\in \EL _2$ mit $xy \in w_1\| w_2$.\\
  Im Folgenden wird für alle Fälle von $xy$ gezeigt, dass es ein $v\in \PrET
  _{12} \cup \MIT _{12}$ gibt, das ein Präfix von $xy$ ist und $v$ entweder auf
  einen Input $I_{12}$ endet oder $v=\varepsilon$. Damit muss $v$ ein Präfix
  von $x$ sein. $\varepsilon$ ist Präfix von jedem Wort und sobald $v$
  mindestens einen Buchstaben enthält, muss das Ende von $v$ vor dem Anfang von
  $y\in O_{12}^*$ liegen. Dadurch ist ein Präfix von $x$ in $\PrET _{12}\cup
  \MIT _{12}$ enthalten und somit gilt $x\in \ET _{12}$, da \ET{} die
  Fortsetzung der Mengenvereinigung aus \PrET{} und \MIT{} ist.\\
  Sei $v_1$ das kürzeste Präfix von $w_1$ in $\PrET _1\cup \MIT _1$. Falls $w_2
  \in L_2$, so sei $v_2=w_2$, sonst soll $v_2$ das kürzeste Präfix von $w_2$ in
  $\PrET _2\cup \MIT _2$ sein. Jede Aktion in $v_1$ und $v_2$ hängt mit einer
  aus $xy$ zusammen. Es kann nun davon ausgegangen werden, dass entweder $v_2 =
  w_2\in L_2$ gilt oder die letzte Aktion von $v_1$ vor oder gleichzeitig mit
  der letzten Aktion von $v_2$ statt findet. Ansonsten endet $v_2 \in \PrET
  _2\cup \MIT _2$ vor $v_1$ und somit ist dieser Fall analog zu $v_1$ endet vor
  $v_2$.
  \begin{itemize}
    \item Fall 1 ($v_1=\varepsilon$): Da $\varepsilon\in\PrET _1\cup \MIT _1$,
      ist bereits in $P_1$ ein Fehler"=Zustand lokal erreichbar. $\varepsilon
      \in \MIT _1$ ist nicht möglich, da jedes Element aus \MIT{} nach
      Definition mindestens die Länge $1$ haben muss. Mit der Wahl
      $v'_2=v'=\varepsilon$ ist $v'_2$ ein Präfix von $v_2$.
    \item Fall 2 ($v_1\neq\varepsilon$): Aufgrund der Definitionen von \PrET{}
      und \MIT{} endet $v_1$ auf ein $a\in I_1$, d.h.\ $v_1=v'_1a$. $v'$ sei
      das Präfix von $xy$, das mit der letzten Aktion von $v_1$ endet, d.h.\
      mit $a$ und $v'_2=v'|_{\Sigma _2}$. Falls $v_2=w_2\in L_2$, dann ist
      $v'_2$ ein Präfix von $v_2$. Falls $v_2\in \PrET _2\cup \MIT _2$ gilt,
      dann ist durch die Annahme, dass $v_2$ nicht vor $v_1$ endet, $v'_2$ ein
      Präfix von $v_2$. Im Fall $v_2 \in \MIT _2$ weiß man zusätzlich, dass
      $v_2$ auf $b\in I_2$ endet. Es kann jedoch $a=b$ gelten.
  \end{itemize}
  In allen Fällen erhält man $v'_2=v'|_{\Sigma _2}$ ist ein Präfix von $v_2$
  und $v'\in v_1\|v'_2$ ist ein Präfix von $xy$. Es kann nur für die Fälle
  $a\notin I_2$ gefolgert werden, dass $p_{02} \weakmust[v'_2]$ gilt.
  \begin{itemize}
    \item Fall I ($v_1\in\MIT _1$ und $v_1\neq \varepsilon$): Es gibt einen
      Ablauf der Form $p_{01}\weakmay[v'_1]p_1\nmust[a]$ und es gilt $v'=v''a$.
      \begin{itemize}
        \item Fall Ia) ($a\notin\Sigma _2$): Es gilt $p_{02}\weakmay[v'_2]p_2$
          mit $v''\in v'_1\|v'_2$. Dadurch erhält man $(p_{01},p_{02})
          \weakmay{v''} (p_1,p_2) \nmust[a]$ mit $a\in I_{12}$. Somit wird $v
          := v''a=v'\in\MIT _{12}$ gewählt.
        \item Fall Ib) ($a\in I_2$ und $v'_2\in\MIT _2$): Es gilt $v'_2=v''_2a$
          mit $p_{02}\weakmay[v''_2]\nmust[a]$ und $v''\in v'_1\|v''_2$. $a$
          ist für $P_2$, ebenso wie für $P_1$, ein nicht erzwungener Input.
          Daraus folgt, dass $(p_1,p_2)\nmust[a]$ gilt. Es wird ebenfalls $v :=
          v''a=v'\in\MIT _{12}$ gewählt.
        \item Fall Ic) ($a\in I_2$ und $v'_2\in L_2\backslash\MIT _2$): Es gilt
          $p_{02}\weakmay[v''_2]p_2\must[a]$ mit $v'_2=v''_2a$. Da die
          gemeinsamen Inputs synchronisiert werden, folgt $(p_1,p_2)\nmust[a]$
          bereits aus $q_1\nmust[a]$. Somit kann hier nochmals $v:=v''a=v'\in
          \MIT _{12}$ gewählt werden.
        \item Fall Id) ($a\in O_2$): Es gilt $v'_2=v''_2a$ und $p_{02}
          \weakmay[v'_2]$. Man erhält also $p_{02}\weakmay[v''_2]\may[a]$ mit
          $v''\in v'_1\|v'_2$. Daraus ergibt sich $(p_{01},p_{02})
          \weakmay[v''] (p_1,p_2)$ mit $p_1\nmust[a],a\in I_1$,$q_2\may[a]$ und
          $a\in O_2$, somit gilt $(p_1,p_2)\in E_{12}$. Es wird $v:= \prune
          (v'')\in\PrET _{12}$ gewählt.
      \end{itemize}
    \item Fall II ($v_1\in\PrET _1$): $\exists u_1\in O_1^*: p_{01}
      \weakmay[v_1] p_1 \weakmay[u_1] p'_1$ mit $p'_1\in E_1$. Im Fall $v'_1
      \neq\varepsilon$ kann das $a$, auf das $v_1$ endet, ebenfalls der letzte
      Buchstabe von $v_2$ sein. Im Fall von $v_2\in\MIT _2$ kann somit $a=b$
      gelten, wodurch $v_2=v'_2$ gilt. Dieser Fall verläuft jedoch anlaog zu
      Fall Ic) und wird hier nicht weiter betrachtet. Es gilt für alle anderen
      Fälle $p_{02}\weakmay[v'_2]p_2$ mit $(p_{01},p_{02}) \weakmay[v']
      (q_1,q_2)$.
      \begin{itemize}
        \item Fall IIa) \big($u_2\in (O_1\cap I_2)^*,c\in (O_1\cap I_2)$, sodass
          $u_2c$ Präfix von $u_1|_{I_2}$ mit $p_2 \weakmust[u_2] p'_2
          \nmust[c]$\big): Für das Präfix $u'_1c$ von $u_1$ mit $u'_1c|_{I_2}=u_2c$
          weiß man, dass $q_1\weakmay[u'_1]q''_1\may[c]$. Somit gilt $u'_1\in
          u'_1\|u_2$ und $(p_1,p_2)\weakmay[u'_1](q''_1,q'_2)\in E_{12}$, da
          für $P_2$ der entsprechende Input nicht erzwungen wird, der mit dem
          $c$ Output von $P_1$ zu koppeln wäre. Es hendelt sich also um einen
          neuen Kommunikationsfehler. Es wird $v := \prune (v'u'_1)\in \PrET
          _{12}$ gewählt, dies ist ein Präfix von $v'$, da $u_1\in O_1^*$.
        \item Fall IIb) \big($p_1\weakmust[u_2]p'_2$ mit $u_1=u_1|_{I_2}$\big): Es gilt
          $u_1\in u_1\|u_2$ und $(p_1,p_2)\weakmay[u_1](p'_1,p'_2)\in E_{12}$,
          da $p'_1\in E_1$ und somit handelt es sich in $P_{12}$ um einen
          geerbten Fehler. Nun wird $v:=\prune (v'u_1)\in\PrET _{12}$ gewält,
          das wiederum ein Präfix von $v'$ ist.
      \end{itemize}
  \end{itemize}

  2.:\\
  Durch die Definitionen ist klar, dass $L_i\subseteq \EL _i$ und $\ET
  _i\subseteq \EL _i$ gilt. Die Argumentation startet auf den rechten Seite der
  Gleichung:
  \begin{align*}
    (\EL{}_1\| \EL{}_2)\cup
    \ET{}_{12}&\overset{\ref{KommFehlerSemDef}}{=}\left(\left(L_1\cup
    \ET{}_1\right)\|\left(L_2\cup \ET{}_2\right)\right)\cup \ET{}_{12}\\
    &=(L_1\|L_2) \cup \underset{\overset{1.}{\subseteq}
    \ET{}_{12}}{\underset{\subseteq
    (\EL{}_1\|\ET{}_2)}{\underbrace{(L_1\|\ET{}_2)}}} \cup
    \underset{\overset{1.}{\subseteq} \ET{}_{12}}{\underset{\subseteq
    (\ET{}_1\|\EL{}_2)}{\underbrace{(\ET{}_1\|L_2)}}} \cup
    \underset{\overset{1.}{\subseteq} \ET{}_{12}}{\underset{\subseteq
    (\EL{}_1\|\ET{}_2)}{\underbrace{(\ET{}_1\|\ET{}_2)}}} \cup \ET{}_{12}\\
    &=(L_1\|L_2) \cup \ET{}_{12}\\
    &\overset{\ref{LParallelProp}}{=}L_{12}\cup \ET{}_{12}\\
    &\overset{\ref{KommFehlerSemDef}}{=}\EL{}_{12}.
  \end{align*}
\end{proof}

\begin{Kor}[Kommunikationsfehler-Präkongruenz]
  Die Relation \ERel{} ist eine Präkongruenz bezüglich $\cdot\|\cdot$.
\end{Kor}
\begin{proof}
  Es muss gezeigt werden: Wenn $P_1\ERel P_2$ gilt, dann für jedes
  komponierbare $P_3$ auch $P_{31}\ERel P_{32}$. D.h.\ es ist zu zeigen,
  dass aus $\ET{}_1\subseteq \ET{}_2$ und $\EL{}_1\subseteq \EL{}_2$,
  $\ET{}_{31}\subseteq \ET{}_{32}$ und $\EL{}_{31}\subseteq
  \EL{}_{32}$ folgt. Dies ergibt sich aus der Monotonie von \cont{},
  \prune{} und $\cdot \|\cdot$ auf Sprachen wie folgt:\\
  \begin{itemize}
    \item $\begin{aligned}[t]
        \ET{}_{31} &\overset{\ref{KommFehlerSemSatz}~1.}{=}
      \cont{}\left(\prune{}\left(\left(\ET{}_3\|\EL{}_1\right)\cup
          \left(\EL{}_3\|\ET{}_1\right)\right)\right)\\
      &\hspace{-0.4cm}\overset{\ET{}_1\subseteq
    \ET{}_2}{\overset{\mathrm{und}}{\overset{\EL{}_1\subseteq \EL{}_2}{\subseteq}}}
    \cont{}\left(\prune{}\left(\left(\ET{}_3\|\EL{}_2\right)\cup
        \left(\EL{}_3\|\ET{}_2\right)\right)\right)\\
    &\overset{\ref{KommFehlerSemSatz}~1.}{=} \ET{}_{32},
    \end{aligned}$
    \item $\begin{aligned}[t]
        \EL{}_{31} &\overset{\ref{KommFehlerSemSatz}~2.}{=}
        (\EL{}_3\|\EL{}_1)\cup E_{31}\\
        &\hspace{-0.5cm}\overset{\EL{}_1\subseteq
      \EL{}_2}{\overset{\mathrm{und}}{\overset{\ET{}_{31}\subseteq
      \ET{}_{32}}{\subseteq}}} (\EL{}_3\|\EL{}_2)\cup \ET{}_{32}\\
      &\overset{\ref{KommFehlerSemSatz}~2.}{=} \EL{}_{32}.
    \end{aligned}$
  \end{itemize}
\end{proof}

\begin{Lem}[Verfeinerung mit Kommunikationsfehlern]
  Gegeben sind zwei \MEIO{}s $P_1$ und $P_2$ mit der gleichen Signatur. Wenn
  $U\|P_1\EBRel{} U\|P_2$ für alle Partner $U$ gilt, dann folgt daraus die
  Gültigkeit von $P_1\ERel{} P_2$.
\end{Lem}

\begin{proof}
  Da $P_1$ und $P_2$ die gleiche Signaturen haben wird $I:=I_1=I_2$ und
  $O:=O_1=O_2$ definiert. Für jeden Partner $U$ gilt $I_U=O$ und $O_U=I$.\\
  Um $P_1\ERel{}P_2$ zu zeigen, wird nachgeprüft, ob folgendes gilt:
  \begin{itemize}
    \item $\ET _1\subseteq \ET _2$,
    \item $\EL _1\subseteq \EL _2$.
  \end{itemize}
  Für ein gewähltes präfix-minimales Element $w\in\ET _1$ wir gezeigt, dass
  dieses $w$ oder eines seiner Präfixe in $\ET _2$ enthalten ist. Dies ist
  möglich, da die beiden Mengen $\ET _1$ und $\ET _2$ durch \cont{}
  abgeschlossen sind.
  \begin{itemize}
    \item Fall 1 ($w=\varepsilon$): Es handelt sich um einen lokal erreichbaren
      Fehler-Zustand in $P_1$. Für $U$ wird ein Transitionssystem verwendet,
      das nur aus dem Startzustand und einer must-Schleife für alle Inputs
      $x\in I_U$ besteht. Somit kann $P_1$ die im Prinzip gleichen
      Fehler-Zustände lokal erreichen wie $U\|P_1$. Daraus folgt, dass auch
      $U\|P_2$ einen lokal erreichbaren Fehler-Zustand haben muss. Durch die
      Definition von $U$ kann dieser Fehler nur von $P_2$ geerbt sein. Es
      muss also in $P_2$ ein Fehler-Zustand durch interne Aktionen und Outputs
      erreichbar sein, d.h.\ es gilt $\varepsilon\in \PrET{}_2$.
    \item Fall 2 ($w=x_1\dots x_n x_{n+1}\in\Sigma ^+$ mit $n\geq 0$ und
      $x_{n+1}\in I = O_U$): Es wird der folgende Partner $U$ betrachtet (siehe
      auch Abbildung~\ref{UohneE}):
      \begin{itemize}
        \item $U=\{p_0,p_1,\dots ,p_{n+1}\}$,
        \item $p_{0U}=p_0$,
        \item $\begin{aligned}[t]
            \must _U=&\{(p_i,x_{i+1},p_{i+1})\mid  0\leq i\leq n\}\\
            &\cup\{(p_i,x,p_{n+1})\mid  x\in I_U\backslash\{x_{i+1}\}, 0\leq
            i\leq n\}\\
            &\cup\{(p_{n+1},x,p_{n+1})\mid  x\in I_U\}.
        \end{aligned}$
        \item $E_U=\emptyset$,
      \end{itemize}
      \begin{figure} [h!tbp]
      \begin{center}
        \begin{tikzpicture}[->, >=latex',auto,node distance =3cm, semithick]

          \node (0) {$p_0$};
          \node (1) [right of=0] {$p_1$};
          \node (dots) [right of=1] {$\dots$};
          \node (n) [right of=dots] {$p_n$};
          \node (n1) at ($(1)!0.5!(dots) + (0,-3)$) {$p_{n+1}$};

          \path ($ (0) + (-1,0) $) edge (0)
                (0) edge node {$x_1$} (1)
                    edge [bend right] node [below, sloped] {$x?\neq x_1$} (n1)
                (1) edge node {$x_2$} (dots)
                    edge node [below, sloped] {$x?\neq x_2$} (n1)
                (dots) edge node {$x_n$} (n)
                       edge [dashed] (n1)
                (n) edge node [above, sloped] {$x?\in I_U$} (n1)
                    edge [bend left] node [sloped] {$x_{n+1}$!} (n1)
                (n1) edge [loop below] node {$x?\in I_U$} (n1);
        \end{tikzpicture}
        \caption{$x?\neq x_i$ steht für alle $x\in I_U\backslash\{x_i\}$}
      \label{UohneE}
      \end{center}
      \end{figure}
      Für $w$ können nun zwei Fälle unterschieden werden. Aus beiden wird
      folgen, dass $\varepsilon\in\PrET(U\|P_1)$.
      \begin{itemize}
        \item Fall 2a) ($w\in\MIT _1$): In $U\|P_1$ erhält man $(p_1,p_{01})
          \weakmay[x_1\dots x_n] (p_n,p')$ mit $p'\nmust[x_{n+1}]$ und
          $p_n\must[x_{n+1}]$. Deshalb gilt $(p_1,p')\in E_{U\|P_1}$. Da alle
          Aktionen aus $w$ bis auf $x_{n+1}$ synchonisiert werden und $I\cap
          I_U=\emptyset$, gilt $x_1,\dots x_n\in O_{U\|P_1}$. Daraus ergibt
          sich dann $\varepsilon\in\PrET (U\|P_1)$.
        \item Fall 2b) ($w\in\PrET _1$): In $U\|P_1$ erhält man $(p_0,p_{01})
          \weakmay[w](p_{n+1},p'')\weakmay[u](p_{n+1},p')$ für $u\in O^*$ und
          $p'\in E_1$. Daraus folgt $(p_{n+1},p')\in E_{U\|P_1}$ und somit
          $wu\in\StET (U\|P_1)$. Da alle Aktionen in $w$ synchonisiert werden
          und $I\cap I_U=\emptyset$, gilt $x_1,\dots ,x_n,x_{n+1}\in
          O_{U\|P_1}$ und, da $u\in O^*$, folgt $u\in O_{U\|P_1}^*$. Somit
          ergibt sich $\varepsilon\in\PrET (U\|P_1)$.
      \end{itemize}
      Da $\varepsilon\in\PrET (U\|P_1)$ gilt, kann durch $U\|P_1\EBRel U\|P_2$
      geschlossen werden, dass auch in $U\|P_2$ ein Fehler-Zustand lokal
      erreichbar sein muss.\\
      Dieser Fehler kann geerbt oder neu sein.
      \begin{itemize}
        \item Fall 2i) (neuer Fehler): Da jeder Zustand von $U$ alle Inputs
          $x\in O=I_U$ durch must"=Transitionen erzwingt, muss ein lokal
          erreichbarer Fehler-Zustand der Form sein, dass ein Output $a\in O_U$
          von $U$ möglich ist, der nicht mit einem passenden Input aus $P_2$
          synchronisiert werden muss ($P_2$ enthält die entsprechende $a$
          Transitonen nicht als must"=Transition). Durch die Konstruktion von
          $U$ sind in $p_{n+1}$ keine Outputs möglich. Ein neuer
          Kommunikationsfehler muss also die Form $(p_i,p')$ haben mit $i\leq
          n, p'\nmust[x_{i+1}]$ und $x_[i+1]\in O_U=I$. Durch Projektion erhält
          man dann $p_{02}\weakmay[x_1\dots x_i]p'\nmust[x_{i+1}]$ und damit
          gilt $x_1\dots x_{i+1}\in\MIT _2\subseteq \ET _2$. Somit ist ein
          Präfix von $w$ in $\ET _2$ entahlten.
        \item Fall 2ii) (geerbter Fehler): $U$ hat $x_1\dots x_iu$ mit $u\in
          I_U^*=O^*$ ausgeführt und ebenso hat $P_2$ dieses Wort abgearbeitet.
          Durch dies hat $P_2$ einen Zustand $E_2$ erreicht, da von $U$ kleine
          Fehler geerbt werden können. Es gilt dann $\prune (x_1\dots x_iu) =
          \prune (x_1\dots x_i)\in\PrET _2\subseteq \ET _2$. Da $x_1\dots x_i$
          ein Präfix von $w$ ist, führt in diesem Fall eine Verlängerung um
          lokale Aktionen von einem Präfix von $w$ zu einem Fehler-Zustand. Da
          \ET{} der Menge aller Verlängerungen von gekürzten
          Kommunikationsfehler-Traces entspricht, ist $x_1\dots x_i$ in $\ET
          _2$ enthalten und somit ist ein Präfix von $w$ in $\ET _2$ enthalten.
      \end{itemize}
  \end{itemize}

  Um die andere Inklustion zu beweisen, reicht es aufgrund der ersten
  Inklustion und der Defintion von \EL{} aus zu zeigen, dass $L_1\backslash\ET
  _1\subseteq \EL _2$ gilt.\\
  Es wird dafür ein beliebiges $w\in L_1\backslash \ET _1$ gewält und gezeigt,
  dass es in $\EL _2$ enthalten ist.
  \begin{itemize}
    \item Fall 1 ($w=\varepsilon$): Da $\varepsilon$ immer in $\EL _2$
      enthalten ist, muss hier nicht gezeigt werden.
    \item Fall 2 ($w=x_1\dots x_n$ mit $n\geq 1$): Es wird ein Partner $U$ wir
      folgt konstruiert (siehe dazu auch Abbildung~\ref{UmitE})
      \begin{itemize}
        \item $U=\{p_0,p_1,\dots ,p_n,p\}$,
        \item $p_{0U}=p_0$,
        \item $\begin{aligned}[t]
            \must _U=&\{(p_i,x_{i+1},p_{i+1})\mid 0\leq i< n\}\\
            &\cup\{(p_i,x,p)\mid x\in I_U\backslash\{x_{i+1}\},0\leq i< n\}\\
            &\cup\{(p,x,p)\mid x\in I_U\}.
        \end{aligned}$
        \item $E_U=\{p_n\}$,
      \end{itemize}
      \begin{figure} [h!tbp]
      \begin{center}
        \begin{tikzpicture}[->, >=latex',auto,node distance =3cm, semithick]

          \node (0) {$p_0$};
          \node (1) [right of=0] {$p_1$};
          \node (dots) [right of=1] {$\dots$};
          \node (n1) [right of=dots] {$p_{n-1}$};
          \node (n) [right of=n1, rectangle, draw] {$p_n\in E_U$};
          \node (q) at ($(1)!0.5!(dots) + (0,-3)$) {$p$};

          \path ($ (0) + (-1,0) $) edge (0)
                (0) edge node {$x_1$} (1)
                    edge [bend right] node [below, sloped] {$x?\neq x_1$} (q)
                (1) edge node {$x_2$} (dots)
                    edge node [below, sloped] {$x?\neq x_2$} (q)
                (dots) edge node {$x_{n-1}$} (n1)
                       edge [dashed] (q)
                (n1) edge node {$x_n$} (n)
                edge [bend left] node [below, sloped] {$x?\neq x_n$} (q)
                (q) edge [loop below] node {$x?\in I_U$} (q);
        \end{tikzpicture}
        \caption{$x?\neq x_i$ steht für alle $x\in I_U\backslash\{x_i\}$, $p_n$
          ist der einzige Fehler-Zustand}
      \label{UmitE}
      \end{center}
      \end{figure}
      Da $p_{01}\weakmay[w]p'$ gilt, kann man schließen, dass $U\|P_1$ einen
      lokal erreichbaren geerbten Fehler hat. Somit muss $U\|P_2$ ebenfalls
      einen lokal erreichbaren Fehler-Zustand haben.
      \begin{itemize}
        \item Fall 2a) (neuer Fehler aufgrund von $x_i\in O_U$ und $p_{02}
          \weakmay[x_1\dots x_{i-1}]q''\nmust[x_i]$): Es gilt $x_1\dots x_i\in
          \MIT _2$ und somit $w\in \EL_2$. Anzumerken ist, dass es nur auf
          diesem Weg Outputs von $U$ möglich sind, deshalb gibt es keine
          anderen Outputs von U, die zu einem neuen Fehler führen können.
        \item Fall 2b) (neuer Fehler aufgrund von $a\in O=I_U$): Der einzige
          Zustand, in dem $U$ nicht alle Input erlaubt sind, ist $p_n$, der
          bereits ein Fehler-Zustand ist. Da in diesem Fall dieser Zustand in
          $U\|P_2$ erreichbar ist, besitzt das komponierte \MEIO{} einen
          geerbten Fehler und es gilt $w\in L_2\subseteq \EL _2$, wegen dem
          folgenden Fall 2c).
        \item Fall 2c) (geerbter Fehler von $U$): Da $p_n$ der enizige
          Fehler-Zustand in $U$ ist und alle Aktionen synchonisiert sind, ist
          dies nur möglich, wenn $p_{02} \weakmay[x_1\dots x_n]$ gilt. In
          diesem Fall gilt $w\in L_2\subseteq \EL _2$.
        \item Fall 2d) (geerbter Fehler von $P_2$): Es gilt dann $p_{02}
          \weakmay{x_1\dots x_iu} p'\in E_2$ für $i\geq 0$ und $u\in O^*$.
          Somit ist $x_1\dots x_iu\in\StET _2$ und damit $\prune (x_1\dots
          x_iu) =\prune (x_1\dots x_i)\in\PrET _2\subseteq \EL _2$. Somit gilt
          $w\in\EL _2$.
      \end{itemize}
  \end{itemize}
\end{proof}

Der folgende Satz sagt aus, dass \ERel{} die gröbste Präkongruenz ist, die
charakterisiert werden soll, also gleich der vollständig abstrakten
Präkongruenz \ECRel{}.

\begin{Satz}[Vollständige Abstraktheit für Kommunikationsfehler-Semantik]
  Für zwei \MEIO{}s $P_1$ und $P_2$ mit derselben Signatur gitl $P_1\ECRel
  P_2\Leftrightarrow P_1\ERel{} P_2$.
\end{Satz}

\begin{proof}
  \TODO{beweisen}
\end{proof}
